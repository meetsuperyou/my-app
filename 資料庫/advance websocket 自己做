å¥½ï¼Œæˆ‘å¹«ä½ è¨­è¨ˆä¸€å€‹ Capacitor Plugin ç¯„ä¾‹ï¼Œå¯ä»¥åœ¨ Android / iOS åŸç”Ÿè‡ªè¨‚ Headerï¼Œç„¶å¾Œè®“ Angular å‘¼å«ã€‚é€™æ¨£ä½ å°±èƒ½åœ¨ Capacitor App è£¡ç”¨ WebSocket + Headerã€‚

-------
ğŸ“Œ å°ˆæ¡ˆçµæ§‹
my-app/
 â”œâ”€ src/ (Angular)
 â”œâ”€ android/
 â”œâ”€ ios/
 â”œâ”€ capacitor.config.ts
 â””â”€ websocket-plugin/
     â”œâ”€ android/
     â”‚   â””â”€ WebSocketPlugin.kt
     â”œâ”€ ios/
     â”‚   â””â”€ WebSocketPlugin.swift
     â””â”€ src/
         â””â”€ definitions.ts
         â””â”€ index.ts

1ï¸âƒ£ å»ºç«‹ Capacitor Plugin

åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œï¼š

npx @capacitor/cli plugin:generate


è¼¸å…¥ï¼š

Plugin Name: WebSocketPlugin

Package: com.example.websocket

Language: Kotlin (Android), Swift (iOS)

2ï¸âƒ£ Android (Kotlin, ç”¨ OkHttp)

android/src/main/java/com/example/websocket/WebSocketPlugin.kt

package com.example.websocket

import android.util.Log
import com.getcapacitor.*
import com.getcapacitor.annotation.CapacitorPlugin
import com.getcapacitor.annotation.PluginMethod
import okhttp3.*

@CapacitorPlugin(name = "WebSocketPlugin")
class WebSocketPlugin : Plugin() {
    private var webSocket: WebSocket? = null

    @PluginMethod
    fun connect(call: PluginCall) {
        val url = call.getString("url") ?: return call.reject("URL required")
        val headers = call.getObject("headers") ?: JSObject()

        val client = OkHttpClient()
        val requestBuilder = Request.Builder().url(url)

        headers.keys().forEach { key ->
            requestBuilder.addHeader(key, headers.getString(key))
        }

        val request = requestBuilder.build()
        webSocket = client.newWebSocket(request, object : WebSocketListener() {
            override fun onOpen(ws: WebSocket, response: Response) {
                notifyListeners("open", JSObject())
            }

            override fun onMessage(ws: WebSocket, text: String) {
                val data = JSObject()
                data.put("message", text)
                notifyListeners("message", data)
            }

            override fun onFailure(ws: WebSocket, t: Throwable, r: Response?) {
                val err = JSObject()
                err.put("error", t.localizedMessage)
                notifyListeners("error", err)
            }
        })

        call.resolve()
    }

    @PluginMethod
    fun send(call: PluginCall) {
        val msg = call.getString("message") ?: ""
        webSocket?.send(msg)
        call.resolve()
    }

    @PluginMethod
    fun close(call: PluginCall) {
        webSocket?.close(1000, "Closed by client")
        call.resolve()
    }
}

3ï¸âƒ£ iOS (Swift, ç”¨ Starscream)

å…ˆåœ¨ ios/Podfile åŠ å…¥ï¼š

pod 'Starscream', '~> 4.0.4'


å† cd ios && pod install

ios/Plugin/WebSocketPlugin.swift

import Foundation
import Capacitor
import Starscream

@objc(WebSocketPlugin)
public class WebSocketPlugin: CAPPlugin {
    var socket: WebSocket?

    @objc func connect(_ call: CAPPluginCall) {
        guard let urlString = call.getString("url"),
              let url = URL(string: urlString) else {
            call.reject("URL required")
            return
        }

        var request = URLRequest(url: url)
        if let headers = call.getObject("headers") {
            for (key, value) in headers {
                request.setValue(value as? String, forHTTPHeaderField: key)
            }
        }

        socket = WebSocket(request: request)

        socket?.onEvent = { event in
            switch event {
            case .connected(_):
                self.notifyListeners("open", data: [:])
            case .text(let text):
                self.notifyListeners("message", data: ["message": text])
            case .error(let error):
                self.notifyListeners("error", data: ["error": error?.localizedDescription ?? "Unknown"])
            default:
                break
            }
        }

        socket?.connect()
        call.resolve()
    }

    @objc func send(_ call: CAPPluginCall) {
        let msg = call.getString("message") ?? ""
        socket?.write(string: msg)
        call.resolve()
    }

    @objc func close(_ call: CAPPluginCall) {
        socket?.disconnect()
        call.resolve()
    }
}

4ï¸âƒ£ TypeScript å®šç¾© (websocket-plugin/src/definitions.ts)
export interface WebSocketPlugin {
  connect(options: { url: string; headers?: Record<string, string> }): Promise<void>;
  send(options: { message: string }): Promise<void>;
  close(): Promise<void>;
  addListener(
    eventName: "open" | "message" | "error",
    listenerFunc: (data: any) => void
  ): Promise<PluginListenerHandle>;
}

5ï¸âƒ£ åœ¨ Angular ç«¯ä½¿ç”¨
import { Plugins } from '@capacitor/core';
const { WebSocketPlugin } = Plugins;

async function startWS() {
  await WebSocketPlugin.connect({
    url: "wss://example.com/socket",
    headers: {
      Authorization: "Bearer 123456",
      "X-Custom": "Hello"
    }
  });

  WebSocketPlugin.addListener("open", () => console.log("Connected"));
  WebSocketPlugin.addListener("message", (data) => console.log("Message:", data.message));
  WebSocketPlugin.addListener("error", (err) => console.error("Error:", err));

  await WebSocketPlugin.send({ message: "Hello from Capacitor" });
}


âœ… é€™æ¨£å°±å®Œæˆäº†ï¼š

Angular å‘¼å« Capacitor Plugin

Android / iOS åŸç”Ÿ WebSocket æ”¯æ´è‡ªè¨‚ Header

API è·Ÿç€è¦½å™¨çš„ WebSocket é¡ä¼¼ï¼Œå­¸ç¿’æˆæœ¬ä½

è¦ä¸è¦æˆ‘å¹«ä½ å†åŠ ä¸€å€‹ã€ŒWeb fallback (ç›´æ¥ç”¨åŸç”Ÿ WebSocket)ã€ï¼Œé€™æ¨£ä½ åœ¨ ç€è¦½å™¨è·‘ Angularæ™‚ä¹Ÿèƒ½æ¸¬è©¦ï¼Ÿ

------
capacitor, æœ‰æ²’æœ‰ websocket å¯ä»¥è‡ªè¨‚ header çš„
https://chatgpt.com/s/t_68add14107408191a425d2b01f1f8323
-----------------
å¥½ï¼Œæˆ‘å¹«ä½ è¨­è¨ˆä¸€å€‹ Capacitor Plugin ç¯„ä¾‹ï¼Œå¯ä»¥åœ¨ Android / iOS åŸç”Ÿè‡ªè¨‚ Headerï¼Œç„¶å¾Œè®“ Angular å‘¼å«ã€‚é€™æ¨£ä½ å°±èƒ½åœ¨ Capacitor App è£¡ç”¨ WebSocket + Headerã€‚
https://chatgpt.com/s/t_68add17024248191bf4fadc0c6a13d6b
----------
è¦ä¸è¦æˆ‘å¹«ä½ å†åŠ ä¸€å€‹ã€ŒWeb fallback (ç›´æ¥ç”¨åŸç”Ÿ WebSocket)ã€ï¼Œé€™æ¨£ä½ åœ¨ ç€è¦½å™¨è·‘ Angularæ™‚ä¹Ÿèƒ½æ¸¬è©¦ï¼Ÿ
https://chatgpt.com/s/t_68add18f3b508191ab6cd1e6c8ce373d
-----------
å¥½ ğŸ‘ é‚£æˆ‘å¹«ä½ åŒ…æˆ Angular Serviceï¼Œä½ å°±å¯ä»¥åœ¨ä»»ä½• Component è£¡ç›´æ¥ç”¨ this.wsService.connect()ã€this.wsService.send()ã€‚
https://chatgpt.com/s/t_68add1ad60208191bbe79d939ca12287
-----------
